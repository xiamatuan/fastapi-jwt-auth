
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastAPI extension that provides JWT Auth support (secure, easy to use, and lightweight)">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.0">
    
    
      
        <title>JWT in Cookies - FastAPI JWT Auth</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bc7e593a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab28b872.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="FastAPI JWT Auth" class="md-header-nav__button md-logo" aria-label="FastAPI JWT Auth">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            FastAPI JWT Auth
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              JWT in Cookies
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/IndominusByte/fastapi-jwt-auth/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    IndominusByte/fastapi-jwt-auth
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FastAPI JWT Auth" class="md-nav__button md-logo" aria-label="FastAPI JWT Auth">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    FastAPI JWT Auth
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/IndominusByte/fastapi-jwt-auth/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    IndominusByte/fastapi-jwt-auth
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Usage
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Usage" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Usage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../basic/" class="md-nav__link">
      Basic Usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../optional/" class="md-nav__link">
      Partially Protecting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../refresh/" class="md-nav__link">
      Refresh Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../freshness/" class="md-nav__link">
      Freshness Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../revoking/" class="md-nav__link">
      Revoking Tokens
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
    <a href="./" class="md-nav__link md-nav__link--active">
      JWT in Cookies
    </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Configuration Options
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Configuration Options" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Configuration Options
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/general/" class="md-nav__link">
      General Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/headers/" class="md-nav__link">
      Headers Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/denylist/" class="md-nav__link">
      Denylist Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/cookies/" class="md-nav__link">
      Cookies Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/csrf/" class="md-nav__link">
      CSRF Options
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../api-doc/" class="md-nav__link">
      API Documentation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contributing/" class="md-nav__link">
      Development - Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../release-notes/" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/IndominusByte/fastapi-jwt-auth/edit/master/docs/usage/jwt-in-cookies.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>JWT in Cookies</h1>
                
                <p>Highly recommended using JWT in cookies, if your frontend interacts with the backend, your frontend may be storing JWT in the browser localStorage or sessionStorage. There is nothing wrong with this, but if you have any sort of XSS vulnerability on your site, an attacker will be able to trivially steal your tokens. If you want some additional security on your site, you can save your JWT in an httponly cookies. Which keeps javascript cannot be able to access the cookies.</p>
<p>Here is a basic example of how to store JWT in cookies:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth</span> <span class="kn">import</span> <span class="n">AuthJWT</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth.exceptions</span> <span class="kn">import</span> <span class="n">AuthJWTException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Note: This is just a basic example how to enable cookies.</span>
<span class="sd">This is vulnerable to CSRF attacks, and should not be used this example.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">authjwt_secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
    <span class="c1"># Configure application to store and get JWT from cookies</span>
<span class="hll">    <span class="n">authjwt_token_location</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cookies&quot;</span><span class="p">}</span>
</span>    <span class="c1"># Disable CSRF Protection for this example. default is True</span>
<span class="hll">    <span class="n">authjwt_cookie_csrf_protect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span>
<span class="nd">@AuthJWT</span><span class="o">.</span><span class="n">load_config</span>
<span class="k">def</span> <span class="nf">get_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Settings</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">AuthJWTException</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">authjwt_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">AuthJWTException</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
    <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Bad username or password&quot;</span><span class="p">)</span>

    <span class="c1"># Create the tokens and passing to set_access_cookies or set_refresh_cookies</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="c1"># Set the JWT cookies in the response</span>
<span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">set_access_cookies</span><span class="p">(</span><span class="n">access_token</span><span class="p">)</span>
</span><span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">set_refresh_cookies</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;Successfully login&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/refresh&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="n">new_access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">current_user</span><span class="p">)</span>
    <span class="c1"># Set the JWT cookies in the response</span>
<span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">set_access_cookies</span><span class="p">(</span><span class="n">new_access_token</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;The token has been refresh&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Because the JWT are stored in an httponly cookie now, we cannot</span>
<span class="sd">    log the user out by simply deleting the cookies in the frontend.</span>
<span class="sd">    We need the backend to send us a response to delete the cookies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

<span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">unset_jwt_cookies</span><span class="p">()</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;Successfully logout&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/protected&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">protected</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We do not need to make any changes to our protected endpoints. They</span>
<span class="sd">    will all still function the exact same as they do when sending the</span>
<span class="sd">    JWT in via a headers instead of a cookies</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">}</span>
</code></pre></div>
<p>This isn't the full story. However now we can keep our cookies from being stolen via XSS attacks, but session cookies vulnerable to CSRF attacks. To combat CSRF attacks we are going to use a technique called double submit cookie pattern. Double submitting cookies is defined as sending a random value in both a cookie and as a request parameter, with the server verifying if the cookie value and request value are equal.</p>
<figure>
  <img src="https://miro.medium.com/max/648/1*WP_VXYjJxUyqfrul8K-4uw.png"/>
  <figcaption>
    <a href="https://medium.com/@kaviru.mihisara/double-submit-cookie-pattern-820fc97e51f2" target="_blank">
      Double Submit Cookie Pattern
    </a>
  </figcaption>
</figure>

<p>This tokens is saved in a cookie with httponly set to True, so it cannot be accessed via javascript. We will then create a secondary cookie that contains an only random string, but has httponly set to False so that it can be accessed via javascript running on your website.</p>
<p>Now in order to access a protected endpoint, you will need to add a custom header that contains the random string in it, and if that header doesn’t exist or it doesn’t match the string that is stored in the JWT, the requester will be kicked out as unauthorized.</p>
<p>To break this down, if an attacker attempts to perform a CSRF attack they will send the JWT <em>(via cookie)</em> to protected endpoint, but without the random string in the request headers, they won't be able to access the endpoint. They cannot access the random string unless they can run javascript on your website <em>likely via an XSS attack</em>, and if they are able to perform an XSS attack, they will not be able to steal the actual access and refresh JWT, as javascript is still not able to access those httponly cookies.</p>
<p>No system is safe. If an attacker can perform an XSS attack they can still access protected endpoints from people who visit your site. However, it is better than if they were able to steal the access and refresh tokens from local/session storage, and use them whenever they wanted.</p>
<p>Here is an example of using cookies with CSRF protection:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth</span> <span class="kn">import</span> <span class="n">AuthJWT</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth.exceptions</span> <span class="kn">import</span> <span class="n">AuthJWTException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">By default, the CRSF cookies will be called csrf_access_token and</span>
<span class="sd">csrf_refresh_token, and in protected endpoints we will look</span>
<span class="sd">for the CSRF token in the &#39;X-CSRF-Token&#39; headers. only certain</span>
<span class="sd">methods should define CSRF token in headers default is (&#39;POST&#39;,&#39;PUT&#39;,&#39;PATCH&#39;,&#39;DELETE&#39;)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">authjwt_secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
    <span class="c1"># Configure application to store and get JWT from cookies</span>
<span class="hll">    <span class="n">authjwt_token_location</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cookies&quot;</span><span class="p">}</span>
</span>    <span class="c1"># Only allow JWT cookies to be sent over https</span>
<span class="hll">    <span class="n">authjwt_cookie_secure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span>    <span class="c1"># Enable csrf double submit protection. default is True</span>
<span class="hll">    <span class="n">authjwt_cookie_csrf_protect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span>    <span class="c1"># Change to &#39;lax&#39; in production to make your website more secure from CSRF Attacks, default is None</span>
<span class="hll">    <span class="c1"># authjwt_cookie_samesite: str = &#39;lax&#39;</span>
</span>
<span class="nd">@AuthJWT</span><span class="o">.</span><span class="n">load_config</span>
<span class="k">def</span> <span class="nf">get_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Settings</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">AuthJWTException</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">authjwt_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">AuthJWTException</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
    <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    With authjwt_cookie_csrf_protect set to True, set_access_cookies() and</span>
<span class="sd">    set_refresh_cookies() will now also set the non-httponly CSRF cookies</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Bad username or password&quot;</span><span class="p">)</span>

    <span class="c1"># Create the tokens and passing to set_access_cookies or set_refresh_cookies</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="c1"># Set the JWT and CSRF double submit cookies in the response</span>
<span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">set_access_cookies</span><span class="p">(</span><span class="n">access_token</span><span class="p">)</span>
</span><span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">set_refresh_cookies</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;Successfully login&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/refresh&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="n">new_access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">current_user</span><span class="p">)</span>
    <span class="c1"># Set the JWT and CSRF double submit cookies in the response</span>
<span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">set_access_cookies</span><span class="p">(</span><span class="n">new_access_token</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;The token has been refresh&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Because the JWT are stored in an httponly cookie now, we cannot</span>
<span class="sd">    log the user out by simply deleting the cookie in the frontend.</span>
<span class="sd">    We need the backend to send us a response to delete the cookies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

<span class="hll">    <span class="n">Authorize</span><span class="o">.</span><span class="n">unset_jwt_cookies</span><span class="p">()</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;Successfully logout&quot;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/protected&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">protected</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">}</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../revoking/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Revoking Tokens
              </div>
            </div>
          </a>
        
        
          <a href="../../configuration/general/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                General Options
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.6a3d08fc.min.js"></script>
      <script src="../../assets/javascripts/bundle.71201edf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>