
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastAPI extension that provides JWT Auth support (secure, easy to use, and lightweight)">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.0">
    
    
      
        <title>Revoking Tokens - FastAPI JWT Auth</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bc7e593a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab28b872.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="FastAPI JWT Auth" class="md-header-nav__button md-logo" aria-label="FastAPI JWT Auth">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            FastAPI JWT Auth
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Revoking Tokens
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/IndominusByte/fastapi-jwt-auth/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    IndominusByte/fastapi-jwt-auth
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FastAPI JWT Auth" class="md-nav__button md-logo" aria-label="FastAPI JWT Auth">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    FastAPI JWT Auth
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/IndominusByte/fastapi-jwt-auth/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    IndominusByte/fastapi-jwt-auth
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Usage
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Usage" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Usage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../basic/" class="md-nav__link">
      Basic Usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../optional/" class="md-nav__link">
      Partially Protecting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../refresh/" class="md-nav__link">
      Refresh Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../freshness/" class="md-nav__link">
      Freshness Tokens
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Revoking Tokens
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../jwt-in-cookies/" class="md-nav__link">
      JWT in Cookies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Configuration Options
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Configuration Options" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Configuration Options
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/general/" class="md-nav__link">
      General Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/headers/" class="md-nav__link">
      Headers Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/denylist/" class="md-nav__link">
      Denylist Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/cookies/" class="md-nav__link">
      Cookies Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../configuration/csrf/" class="md-nav__link">
      CSRF Options
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../api-doc/" class="md-nav__link">
      API Documentation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contributing/" class="md-nav__link">
      Development - Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../release-notes/" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/IndominusByte/fastapi-jwt-auth/edit/master/docs/usage/revoking.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Revoking Tokens</h1>
                
                <p>This will allow you to revoke a specific tokens so that it can no longer access your endpoints. You will have to choose what tokens you want to check against the denylist. Denylist works by providing a callback function to this extension, using the <strong>token_in_denylist_loader()</strong>. This method will be called whenever the specified tokens <em>(access and/or refresh)</em> is used to access a protected endpoint. If the callback function says that the tokens is revoked, we will not allow the requester to continue, otherwise we will allow the requester to access the endpoint as normal.</p>
<p>Here is a basic example use tokens revoking:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth</span> <span class="kn">import</span> <span class="n">AuthJWT</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth.exceptions</span> <span class="kn">import</span> <span class="n">AuthJWTException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># set denylist enabled to True</span>
<span class="c1"># you can set to check access or refresh token or even both of them</span>
<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">authjwt_secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="hll">    <span class="n">authjwt_denylist_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span class="hll">    <span class="n">authjwt_denylist_token_checks</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;access&quot;</span><span class="p">,</span><span class="s2">&quot;refresh&quot;</span><span class="p">}</span>
</span>
<span class="nd">@AuthJWT</span><span class="o">.</span><span class="n">load_config</span>
<span class="k">def</span> <span class="nf">get_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Settings</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">AuthJWTException</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">authjwt_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">AuthJWTException</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
    <span class="p">)</span>


<span class="c1"># A storage engine to save revoked tokens. in production,</span>
<span class="c1"># you can use Redis for storage system</span>
<span class="hll"><span class="n">denylist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span>
<span class="c1"># For this example, we are just checking if the tokens jti</span>
<span class="c1"># (unique identifier) is in the denylist set. This could</span>
<span class="c1"># be made more complex, for example storing the token in Redis</span>
<span class="c1"># with the value true if revoked and false if not revoked</span>
<span class="hll"><span class="nd">@AuthJWT</span><span class="o">.</span><span class="n">token_in_denylist_loader</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">check_if_token_in_denylist</span><span class="p">(</span><span class="n">decrypted_token</span><span class="p">):</span>
</span><span class="hll">    <span class="n">jti</span> <span class="o">=</span> <span class="n">decrypted_token</span><span class="p">[</span><span class="s1">&#39;jti&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">jti</span> <span class="ow">in</span> <span class="n">denylist</span>
</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Bad username or password&quot;</span><span class="p">)</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span> <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">}</span>

<span class="c1"># Standard refresh endpoint. Token in denylist will not</span>
<span class="c1"># be able to access this endpoint</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/refresh&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="n">new_access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">current_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access_token</span><span class="p">}</span>

<span class="c1"># Endpoint for revoking the current users access token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/access-revoke&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">access_revoke</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s1">&#39;jti&#39;</span><span class="p">]</span>
<span class="hll">    <span class="n">denylist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span><span class="s2">&quot;Access token has been revoke&quot;</span><span class="p">}</span>

<span class="c1"># Endpoint for revoking the current users refresh token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/refresh-revoke&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh_revoke</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s1">&#39;jti&#39;</span><span class="p">]</span>
<span class="hll">    <span class="n">denylist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span><span class="s2">&quot;Refresh token has been revoke&quot;</span><span class="p">}</span>

<span class="c1"># A token in denylist will not be able to access this any more</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/protected&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">protected</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">}</span>
</code></pre></div>
<p>In production, you will likely want to use either a database or in-memory store (such as Redis) to store your tokens. Memory stores are great if you are wanting to revoke a tokens when the users log out and you can define timeout to your tokens in Redis, after the timeout has expired, the tokens will automatically be deleted.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before that make sure redis already installed on your local machine,
you can use docker using this command <code>docker run -d -p 6379:6379 redis</code></p>
</div>
<p>Here example use Redis for revoking a tokens:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth</span> <span class="kn">import</span> <span class="n">AuthJWT</span>
<span class="kn">from</span> <span class="nn">fastapi_jwt_auth.exceptions</span> <span class="kn">import</span> <span class="n">AuthJWTException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="hll"><span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>
</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">authjwt_secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="hll">    <span class="n">authjwt_denylist_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span class="hll">    <span class="n">authjwt_denylist_token_checks</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;access&quot;</span><span class="p">,</span><span class="s2">&quot;refresh&quot;</span><span class="p">}</span>
</span><span class="hll">    <span class="n">access_expires</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span class="hll">    <span class="n">refresh_expires</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>

<span class="nd">@AuthJWT</span><span class="o">.</span><span class="n">load_config</span>
<span class="k">def</span> <span class="nf">get_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">settings</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">AuthJWTException</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">authjwt_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">AuthJWTException</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
    <span class="p">)</span>


<span class="c1"># Setup our redis connection for storing the denylist tokens</span>
<span class="hll"><span class="n">redis_conn</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span>
<span class="c1"># Create our function to check if a token has been revoked. In this simple</span>
<span class="c1"># case, we will just store the tokens jti (unique identifier) in redis.</span>
<span class="c1"># This function will return the revoked status of a token. If a token exists</span>
<span class="c1"># in redis and value is true, token has been revoked</span>
<span class="hll"><span class="nd">@AuthJWT</span><span class="o">.</span><span class="n">token_in_denylist_loader</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">check_if_token_in_denylist</span><span class="p">(</span><span class="n">decrypted_token</span><span class="p">):</span>
</span><span class="hll">    <span class="n">jti</span> <span class="o">=</span> <span class="n">decrypted_token</span><span class="p">[</span><span class="s1">&#39;jti&#39;</span><span class="p">]</span>
</span><span class="hll">    <span class="n">entry</span> <span class="o">=</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">jti</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">entry</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Bad username or password&quot;</span><span class="p">)</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span> <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">}</span>

<span class="c1"># Standard refresh endpoint. Token in denylist will not</span>
<span class="c1"># be able to access this endpoint</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/refresh&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="n">new_access_token</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">current_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access_token</span><span class="p">}</span>

<span class="c1"># Endpoint for revoking the current users access token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/access-revoke&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">access_revoke</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="c1"># Store the tokens in redis with the value true for revoked.</span>
    <span class="c1"># We can also set an expires time on these tokens in redis,</span>
    <span class="c1"># so they will get automatically removed after they expired.</span>
    <span class="n">jti</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s1">&#39;jti&#39;</span><span class="p">]</span>
<span class="hll">    <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">jti</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">access_expires</span><span class="p">,</span><span class="s1">&#39;true&#39;</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span><span class="s2">&quot;Access token has been revoke&quot;</span><span class="p">}</span>

<span class="c1"># Endpoint for revoking the current users refresh token</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;/refresh-revoke&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">refresh_revoke</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_refresh_token_required</span><span class="p">()</span>

    <span class="n">jti</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_raw_jwt</span><span class="p">()[</span><span class="s1">&#39;jti&#39;</span><span class="p">]</span>
<span class="hll">    <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">jti</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">refresh_expires</span><span class="p">,</span><span class="s1">&#39;true&#39;</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span><span class="s2">&quot;Refresh token has been revoke&quot;</span><span class="p">}</span>

<span class="c1"># A token in denylist will not be able to access this any more</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/protected&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">protected</span><span class="p">(</span><span class="n">Authorize</span><span class="p">:</span> <span class="n">AuthJWT</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()):</span>
    <span class="n">Authorize</span><span class="o">.</span><span class="n">jwt_required</span><span class="p">()</span>

    <span class="n">current_user</span> <span class="o">=</span> <span class="n">Authorize</span><span class="o">.</span><span class="n">get_jwt_subject</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">}</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../freshness/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Freshness Tokens
              </div>
            </div>
          </a>
        
        
          <a href="../jwt-in-cookies/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                JWT in Cookies
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.6a3d08fc.min.js"></script>
      <script src="../../assets/javascripts/bundle.71201edf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>